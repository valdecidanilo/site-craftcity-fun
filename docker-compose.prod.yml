#!/usr/bin/env bash
set -euo pipefail

CONTAINER_NAME="craftcity-web"
IMAGE_NAME="craftcity-next"
MODE="${2:-prod}"                     # default prod pra ficar alinhado ao compose prod
PORT="${PORT:-3000}"

# Lê .env da raiz (se existir) para exportar vars importantes
if [[ -f .env ]]; then
  export $(grep -v '^#' .env | xargs)
fi

# URL pública
if [[ "$MODE" == "prod" ]]; then
  : "${NEXT_PUBLIC_BASE_URL:?Defina NEXT_PUBLIC_BASE_URL no .env (ex: https://loja.craftcity.fun)}"
  NEXTAUTH_URL="${NEXT_PUBLIC_BASE_URL}"
  NODE_ENV="production"
  echo "🚀 Modo PRODUÇÃO - NEXTAUTH_URL: $NEXTAUTH_URL"
else
  NEXTAUTH_URL="http://localhost:$PORT"
  NODE_ENV="development"
  echo "🛠️  Modo DEV - NEXTAUTH_URL: $NEXTAUTH_URL"
fi

# Verificações
if ! command -v docker >/dev/null 2>&1; then
  echo "❌ Docker não encontrado"; exit 1
fi

case "${1:-}" in
  build)
    echo "🔧 Build ($MODE)…"
    docker build -t "$IMAGE_NAME" .
    ;;

  start)
    echo "🚀 Subindo ($MODE)…"
    # Para e remove container antigo se existir
    docker rm -f "$CONTAINER_NAME" >/dev/null 2>&1 || true
    # Sobe com variáveis essenciais (use --env-file para carregar tudo do .env)
    docker run -d \
      --name "$CONTAINER_NAME" \
      -p "$PORT:3000" \
      --restart unless-stopped \
      --env-file .env \
      -e NODE_ENV="$NODE_ENV" \
      -e NEXTAUTH_URL="$NEXTAUTH_URL" \
      -e NEXTAUTH_SECRET="${NEXTAUTH_SECRET:?Defina NEXTAUTH_SECRET no .env}" \
      "$IMAGE_NAME"
    ;;

  stop)
    echo "🛑 Parando…"
    docker rm -f "$CONTAINER_NAME" >/dev/null 2>&1 || true
    ;;

  restart)
    echo "🔄 Reiniciando ($MODE)…"
    "$0" stop
    "$0" build "$MODE"
    "$0" start "$MODE"
    ;;

  status)
    docker ps -a | grep "$CONTAINER_NAME" || echo "Container não encontrado"
    ;;

  logs)
    docker logs -f "$CONTAINER_NAME"
    ;;

  *)
    cat <<USAGE
Uso:
  ./docker-app.sh build [dev|prod]
  ./docker-app.sh start [dev|prod]
  ./docker-app.sh stop
  ./docker-app.sh restart [dev|prod]
  ./docker-app.sh status
  ./docker-app.sh logs

Requisitos no .env (raiz):
  NEXT_PUBLIC_BASE_URL=https://loja.craftcity.fun
  NEXTAUTH_SECRET=uma-string-bem-grande
  GOOGLE_CLIENT_ID=...
  GOOGLE_CLIENT_SECRET=...
  MERCADOPAGO_ACCESS_TOKEN=...
USAGE
    exit 1
    ;;
esac
